#include <stdint.h>
#include <stdbool.h>
#include <string.h>
#include "freertos/FreeRTOS.h"
#include "freertos/task.h"
#include "esp_log.h"
#include "esp_wifi.h"
#include "esp_event.h"
#include "nvs_flash.h"
#include "lwip/sockets.h"

// BACnet Stack Includes
#include "bacnet/config.h"
#include "bacnet/datalink/bip.h"
#include "bacnet/basic/object/device.h"
#include "bacnet/datalink/datalink.h"
#include "bacnet/basic/tsm/tsm.h"
#include "bacnet/basic/sys/mstimer.h"

static const char *TAG = "BACNET_MAIN";

// --- Wi-Fi Configuration (CHANGE THESE!) ---
#define WIFI_SSID      "YOUR_WIFI_NAME"
#define WIFI_PASS      "YOUR_WIFI_PASSWORD"

// BACnet Device Info
#define DEVICE_ID      12345
#define DEVICE_NAME    "ESP32_Solar_Robot"

// --- Wi-Fi Event Handler ---
static void wifi_event_handler(void* arg, esp_event_base_t event_base,
                               int32_t event_id, void* event_data) {
    if (event_base == WIFI_EVENT && event_id == WIFI_EVENT_STA_START) {
        esp_wifi_connect();
    } else if (event_base == WIFI_EVENT && event_id == WIFI_EVENT_STA_DISCONNECTED) {
        ESP_LOGI(TAG, "Wi-Fi disconnected, retrying...");
        esp_wifi_connect();
    } else if (event_base == IP_EVENT && event_id == IP_EVENT_STA_GOT_IP) {
        ip_event_got_ip_t* event = (ip_event_got_ip_t*) event_data;
        ESP_LOGI(TAG, "Got IP Address: " IPSTR, IP2STR(&event->ip_info.ip));
    }
}

// --- Initialize Wi-Fi ---
void wifi_init_sta(void) {
    nvs_flash_init();
    esp_netif_init();
    esp_event_loop_create_default();
    esp_netif_create_default_wifi_sta();

    wifi_init_config_t cfg = WIFI_INIT_CONFIG_DEFAULT();
    esp_wifi_init(&cfg);

    esp_event_handler_instance_t instance_any_id;
    esp_event_handler_instance_t instance_got_ip;
    esp_event_handler_instance_register(WIFI_EVENT, ESP_EVENT_ANY_ID,
                                        &wifi_event_handler, NULL, &instance_any_id);
    esp_event_handler_instance_register(IP_EVENT, IP_EVENT_STA_GOT_IP,
                                        &wifi_event_handler, NULL, &instance_got_ip);

    wifi_config_t wifi_config = {
        .sta = {
            .ssid = WIFI_SSID,
            .password = WIFI_PASS,
        },
    };
    esp_wifi_set_mode(WIFI_MODE_STA);
    esp_wifi_set_config(WIFI_IF_STA, &wifi_config);
    esp_wifi_start();
}

// --- BACnet Task ---
void bacnet_task(void *pvParameters) {
    // 1. Initialize Device Object
    Device_Set_Object_Instance_Number(DEVICE_ID);
    Device_Object_Name_ANSI_Init(DEVICE_NAME);
    Device_Init(NULL);

    // 2. Initialize DataLink (BACnet/IP)
    // Wait for Wi-Fi to get IP before initializing BIP
    vTaskDelay(pdMS_TO_TICKS(5000)); 
    bip_init(NULL); 

    ESP_LOGI(TAG, "BACnet Stack Initialized");

    // 3. The Main Loop (The "Heartbeat")
    uint8_t pdu[MAX_MPDU];
    uint16_t pdu_len = 0;
    BACNET_ADDRESS src;

    while (1) {
        // A. Check for incoming packets
        pdu_len = bip_receive(&src, &pdu[0], MAX_MPDU, 10); // 10ms timeout

        if (pdu_len > 0) {
            // B. Process packet if received
            npdu_handler(&src, &pdu[0], pdu_len);
        }

        // C. Handle Timers (TSM, Address Binding, CoV)
        // These keep the stack alive
        tsm_timer_milliseconds(10); 
        // datalink_maintenance_timer(10); // Optional depending on stack version

        // D. Delay to prevent watchdog starvation
        vTaskDelay(pdMS_TO_TICKS(10));
    }
}

void app_main(void) {
    // 1. Start Wi-Fi
    wifi_init_sta();

    // 2. Start BACnet Task on Core 1
    xTaskCreatePinnedToCore(bacnet_task, "BACnet_Task", 8192, NULL, 5, NULL, 1);
}