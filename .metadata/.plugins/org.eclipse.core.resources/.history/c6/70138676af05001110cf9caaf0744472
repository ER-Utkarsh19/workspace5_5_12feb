# components/bacnet/CMakeLists.txt

# 1. Setup paths
set(BACNET_ROOT "bacnet-stack")

# 2. Add Source Files
file(GLOB_RECURSE BACNET_SOURCES 
    "${BACNET_ROOT}/src/bacnet/*.c"
)

# 3. EXCLUDE Files causing errors (Clean up the build)
# ---------------------------------------------------
# Exclude Router logic
list(FILTER BACNET_SOURCES EXCLUDE REGEX ".*h_routed_npdu.c$")
list(FILTER BACNET_SOURCES EXCLUDE REGEX ".*s_router.c$")

# Exclude Scripting & Complex Objects
list(FILTER BACNET_SOURCES EXCLUDE REGEX ".*ubasic.*")
list(FILTER BACNET_SOURCES EXCLUDE REGEX ".*trendlog.c$")
list(FILTER BACNET_SOURCES EXCLUDE REGEX ".*time_value.c$")
list(FILTER BACNET_SOURCES EXCLUDE REGEX ".*credential_data_input.c$")
list(FILTER BACNET_SOURCES EXCLUDE REGEX ".*access_.*")

# Exclude Complex Services (Not needed for a simple sensor)
list(FILTER BACNET_SOURCES EXCLUDE REGEX ".*h_whohas.c$")      # Caused the "incompatible pointer" error
list(FILTER BACNET_SOURCES EXCLUDE REGEX ".*h_write_group.c$") # Caused the build stop
list(FILTER BACNET_SOURCES EXCLUDE REGEX ".*h_cov.c$")         # often causes issues if not configured

# Exclude PC/Linux specific files
list(FILTER BACNET_SOURCES EXCLUDE REGEX ".*ports/.*") 
list(FILTER BACNET_SOURCES EXCLUDE REGEX ".*apps/.*")
list(FILTER BACNET_SOURCES EXCLUDE REGEX ".*demo/.*")

# 4. Register the component
idf_component_register(
    SRCS 
        "bacnet.c"           
        ${BACNET_SOURCES}    
    
    INCLUDE_DIRS 
        "include"
        "${BACNET_ROOT}/src"
        "${BACNET_ROOT}/src/bacnet/basic/object"
        "${BACNET_ROOT}/src/bacnet/basic/service"
    
    REQUIRES 
        lwip 
        nvs_flash
)

# 5. Compiler Flags
target_compile_definitions(${COMPONENT_LIB} PUBLIC
    BACNET_STACK_STATIC_DEFINE
    BACDL_BIP=1      
    BACDL_MSTP=0     
    # NOTE: BAC_ROUTING is intentionally removed to disable it
)

# 6. FORCE DISABLE ERRORS (Crucial for ESP-IDF 5.5)
target_compile_options(${COMPONENT_LIB} PRIVATE
    -Wno-error                      # Do not treat warnings as errors
    -Wno-incompatible-pointer-types # Ignore the int vs int32 pointer mismatch
    -Wno-deprecated-declarations    # Ignore old API calls
    -Wno-format                     # Ignore printf format warnings
    -Wno-int-conversion             # Ignore integer conversion warnings
    -Wno-unused-variable
    -Wno-unused-function
    -Wno-pointer-sign
)