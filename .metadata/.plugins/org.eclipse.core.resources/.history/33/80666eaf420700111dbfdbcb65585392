#include "esp_netif.h"
#include "bacnet/datalink/bip.h"
#include "bacnet/basic/services.h"

void bacnet_ip_client_task(void *pvParameters) {
    // 1. Wait for IP address from WiFi/Ethernet
    // (Ensure your WiFi/Eth init code sets a bit in an event group here)

    // 2. Initialize BACnet/IP Datalink
    // Passing NULL uses the default interface (eth0/st0)
    if (!bip_init(NULL)) {
        printf("Failed to initialize BACnet/IP\n");
        vTaskDelete(NULL);
    }
    printf("BACnet/IP Initialized on Port 0xBAC0\n");

    while (1) {
        // 3. Send Client Requests
        printf("Searching for BACnet/IP devices...\n");
        Send_WhoIs(-1, -1); 

        // 4. Critical: Process incoming packets (Who-Is/I-Am/Read Responses)
        // This keeps the stack alive and processes any incoming data
        uint16_t pdu_len = datalink_receive(NULL, NULL, 0, 0);
        if (pdu_len > 0) {
            // The stack's internal handlers will process the packet here
        }

        vTaskDelay(pdMS_TO_TICKS(5000));
    }
}