# components/bacnet/CMakeLists.txt

# 1. Setup paths
set(BACNET_ROOT "bacnet-stack")

# 2. Add Source Files
file(GLOB_RECURSE BACNET_SOURCES 
    "${BACNET_ROOT}/src/bacnet/*.c"
)

# 3. EXCLUDE Files (The "Ban List")
# ---------------------------------------------------
# Exclude OpenWrt/Linux Configuration (Fixes uci_config.h error)
list(FILTER BACNET_SOURCES EXCLUDE REGEX ".*uci.c$")

# Exclude Router logic (Fixes incompatible pointer error)
list(FILTER BACNET_SOURCES EXCLUDE REGEX ".*h_routed_npdu.c$")
list(FILTER BACNET_SOURCES EXCLUDE REGEX ".*s_router.c$")

# Exclude Scripting & Complex Objects
list(FILTER BACNET_SOURCES EXCLUDE REGEX ".*ubasic.*")
list(FILTER BACNET_SOURCES EXCLUDE REGEX ".*trendlog.c$")
list(FILTER BACNET_SOURCES EXCLUDE REGEX ".*time_value.c$")
list(FILTER BACNET_SOURCES EXCLUDE REGEX ".*credential_data_input.c$")
list(FILTER BACNET_SOURCES EXCLUDE REGEX ".*access_.*")

# Exclude Complex Services 
list(FILTER BACNET_SOURCES EXCLUDE REGEX ".*h_whohas.c$")      
list(FILTER BACNET_SOURCES EXCLUDE REGEX ".*h_write_group.c$") 
list(FILTER BACNET_SOURCES EXCLUDE REGEX ".*h_cov.c$")         

# Exclude PC/Linux/Port specific files
list(FILTER BACNET_SOURCES EXCLUDE REGEX ".*ports/.*") 
list(FILTER BACNET_SOURCES EXCLUDE REGEX ".*apps/.*")
list(FILTER BACNET_SOURCES EXCLUDE REGEX ".*demo/.*")

# 4. Register the component
idf_component_register(
    SRCS 
        "bacnet.c"           
        ${BACNET_SOURCES}    
    
    INCLUDE_DIRS 
        "include"
        "${BACNET_ROOT}/src"
        "${BACNET_ROOT}/src/bacnet/basic/object"
        "${BACNET_ROOT}/src/bacnet/basic/service"
        "${BACNET_ROOT}/src/bacnet/basic/sys"  # Needed for debug.h/ringbuf.h
    
    REQUIRES 
        lwip 
        nvs_flash
)

# 5. Compiler Flags
target_compile_definitions(${COMPONENT_LIB} PUBLIC
    BACNET_STACK_STATIC_DEFINE
    BACDL_BIP=1      
    BACDL_MSTP=0     
    # BAC_ROUTING is REMOVED
)

# 6. FORCE DISABLE ERRORS
target_compile_options(${COMPONENT_LIB} PRIVATE
    -Wno-error                      
    -Wno-incompatible-pointer-types 
    -Wno-deprecated-declarations    
    -Wno-format                     
    -Wno-int-conversion             
    -Wno-unused-variable
    -Wno-unused-function
    -Wno-pointer-sign
)